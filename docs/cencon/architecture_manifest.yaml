# CC Director Architecture Manifest
# CenCon Method - Machine-readable C4 model
# Schema version: 1.0.0

schema_version: "1.0.0"
project:
  name: CC Director
  description: Cross-platform application for managing multiple Claude Code CLI sessions
  version: "1.1.0"
  framework: ".NET 10"
  platform: "Windows 10/11 (WPF), Mac/Linux (experimental backend)"

last_updated: "2026-02-24"

# C4 Level 1: System Context
context:
  system:
    name: CC Director
    description: Multi-session Claude Code management application
    technology: WPF Desktop Application

  actors:
    - id: developer
      name: Developer
      description: Software developer using Claude Code for coding tasks
      type: person
      relationship:
        target: cc_director
        description: Manages multiple Claude Code sessions

    - id: claude_code
      name: Claude Code CLI
      description: Anthropic's CLI for Claude AI assistance
      type: external_system
      relationship:
        target: cc_director
        description: Spawned and monitored by Director via ConPTY

    - id: git
      name: Git
      description: Version control system
      type: external_system
      relationship:
        target: cc_director
        description: Provides repository status information

    - id: openai_api
      name: OpenAI API
      description: Cloud API for speech-to-text and text-to-speech
      type: external_system
      relationship:
        target: cc_director
        description: Voice mode transcription and synthesis

# C4 Level 2: Container Diagram
containers:
  - id: wpf_ui
    name: WPF UI Layer
    technology: C# / WPF / XAML
    description: Desktop application user interface
    project: CcDirector.Wpf
    components:
      - name: MainWindow
        description: Primary window with session sidebar and content area
        file: MainWindow.xaml / MainWindow.xaml.cs
      - name: EmbeddedBackend
        description: Native console window overlay using Win32 SetParent
        file: Backends/EmbeddedBackend.cs
      - name: EmbeddedConsoleHost
        description: WPF control for hosting embedded console windows
        file: Controls/EmbeddedConsoleHost.cs
      - name: TerminalControl
        description: Custom control for terminal rendering with ANSI parsing
        file: Controls/TerminalControl.cs
      - name: Dialogs
        description: Modal dialogs for session management
        files:
          - NewSessionDialog.xaml
          - RenameSessionDialog.xaml
          - RelinkSessionDialog.xaml
          - CloseDialog.xaml
          - CloneRepoDialog.xaml
          - GitHubRepoPickerDialog.xaml
      - name: Voice UI
        description: Voice mode controls and audio playback/recording
        directory: Voice/

  - id: core_services
    name: Core Services Layer
    technology: C# / .NET 10
    description: Business logic and domain services
    project: CcDirector.Core
    components:
      - name: SessionManager
        description: Session lifecycle management
        file: Sessions/SessionManager.cs
      - name: Session
        description: Central session abstraction with activity state machine
        file: Sessions/Session.cs
      - name: ActivityState
        description: Claude cognitive state enum (Idle, Working, WaitingForInput, etc.)
        file: Sessions/ActivityState.cs
      - name: DirectorPipeServer
        description: Named pipe IPC server for hook events
        file: Pipes/DirectorPipeServer.cs
      - name: EventRouter
        description: Routes pipe messages to appropriate sessions
        file: Pipes/EventRouter.cs
      - name: HookInstaller
        description: Manages Claude Code hooks in settings.json
        file: Hooks/HookInstaller.cs
      - name: GitStatusProvider
        description: Async git status polling
        file: Git/GitStatusProvider.cs
      - name: GitSyncStatusProvider
        description: Branch ahead/behind status tracking
        file: Git/GitSyncStatusProvider.cs
      - name: ClaudeSessionReader
        description: Session verification via .jsonl transcript matching
        file: Claude/ClaudeSessionReader.cs
      - name: ClaudeClient
        description: Helper library for Claude CLI interactions
        file: Claude/ClaudeClient.cs
      - name: VoiceModeController
        description: Orchestrates voice interaction flow
        file: Voice/Controllers/VoiceModeController.cs
      - name: CircularTerminalBuffer
        description: Thread-safe ring buffer for terminal output
        file: Memory/CircularTerminalBuffer.cs
      - name: FileLog
        description: Thread-safe async file logging
        file: Utilities/FileLog.cs

  - id: native_apis
    name: Platform-Specific APIs
    technology: Win32 / P/Invoke / libc
    description: Low-level platform API integration
    components:
      - name: ConPTY (Windows)
        description: Windows Pseudo Console (CreatePseudoConsole, ResizePseudoConsole)
        files:
          - ConPty/NativeMethods.cs
          - ConPty/PseudoConsole.cs
          - ConPty/ProcessHost.cs
      - name: Unix PTY (Mac/Linux)
        description: Unix pseudo-terminal (openpty, ioctl TIOCSWINSZ)
        files:
          - UnixPty/UnixNativeMethods.cs
          - UnixPty/UnixPseudoConsole.cs
          - UnixPty/UnixProcessHost.cs
      - name: Window Management (Windows only)
        description: SetParent, MoveWindow for console embedding
        file: Backends/EmbeddedBackend.cs
      - name: IPC Server
        description: Platform-appropriate IPC (Named Pipes on Windows, Unix Sockets on Mac/Linux)
        files:
          - Pipes/IDirectorServer.cs
          - Pipes/DirectorPipeServer.cs
          - Pipes/UnixSocketServer.cs
      - name: Process Management
        description: CreateProcessW (Windows) or fork/exec (Unix)
        files:
          - ConPty/ProcessHost.cs
          - UnixPty/UnixProcessHost.cs

# Data flows
data_flows:
  - id: hook_event_flow
    name: Hook Event Flow
    description: Claude Code hook events to Director UI
    path:
      - Claude Code (claude.exe)
      - "hook-relay script (PowerShell on Windows, Python on Mac/Linux)"
      - "IPC channel (Named Pipe on Windows, Unix Socket on Mac/Linux)"
      - IDirectorServer
      - EventRouter
      - Session.HandlePipeEvent()
      - UI (INotifyPropertyChanged)

  - id: user_input_flow
    name: User Input Flow
    description: User input to Claude session
    path:
      - User input (keyboard)
      - conhost.exe
      - claude.exe (stdin)
      - Hook fires (UserPromptSubmit)
      - "[hook_event_flow]"

  - id: session_restore_flow
    name: Session Restore Flow
    description: Restoring sessions after application restart
    path:
      - Application startup
      - SessionStateStore.Load()
      - SessionManager.RestoreEmbeddedSession()
      - ClaudeSessionReader.VerifyWithTerminalContent()
      - Session verified/linked

  - id: voice_flow
    name: Voice Mode Flow
    description: Voice input to Claude and spoken response
    path:
      - AudioRecorder.StartAsync()
      - OpenAiSttService.TranscribeAsync()
      - Session.SendInputAsync()
      - ClaudeResponseExtractor.GetLatestResponse()
      - ClaudeSummarizer.SummarizeAsync()
      - OpenAiTtsService.SynthesizeAsync()
      - AudioPlayer.PlayAsync()

# Security boundaries
security_boundaries:
  - id: process_isolation
    name: Process Isolation
    description: Each Claude session runs in isolated conhost.exe process
    components:
      - conhost.exe (per session)
      - claude.exe (per session)

  - id: ipc_boundary
    name: IPC Boundary
    description: IPC channels are local-only, no network exposure
    components:
      - "Windows: \\\\.\pipe\\CC_ClaudeDirector (Named Pipe)"
      - "Mac/Linux: ~/.cc_director/director.sock (Unix Socket)"
    security_note: IPC accessible only on local machine

  - id: file_system
    name: File System Locations
    description: Application data storage locations
    paths:
      - logs: "%LOCALAPPDATA%\\CcDirector\\logs\\"
      - sessions: "~/Documents/CcDirector/sessions.json"
      - repositories: "~/Documents/CcDirector/repositories.json"
      - hooks_config: "~/.claude/settings.json"

# Design patterns used
patterns:
  - name: Strategy Pattern
    implementation: ISessionBackend interface with 4 implementations
    purpose: Abstracts terminal hosting modes across platforms
    files:
      - Backends/ISessionBackend.cs
      - Backends/EmbeddedBackend.cs
      - Backends/ConPtyBackend.cs
      - Backends/PipeBackend.cs
      - Backends/UnixPtyBackend.cs

  - name: Observer Pattern
    implementation: Events (StatusChanged, OnActivityStateChanged)
    purpose: UI updates on state changes
    files:
      - Sessions/Session.cs

  - name: State Machine
    implementation: ActivityState enum with HandlePipeEvent()
    purpose: Claude cognitive state tracking
    files:
      - Sessions/ActivityState.cs
      - Sessions/Session.cs

  - name: Producer-Consumer
    implementation: BlockingCollection<string> in FileLog
    purpose: Thread-safe async logging
    files:
      - Utilities/FileLog.cs

  - name: Repository Pattern
    implementation: RecentSessionStore, RepositoryRegistry, SessionStateStore
    purpose: Persistence abstraction
    files:
      - Sessions/RecentSessionStore.cs
      - Sessions/SessionStateStore.cs
      - Configuration/RepositoryRegistry.cs
