<Window x:Class="CcDirector.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:CcDirector.Wpf.Controls"
        Title="CC Director v2"
        Icon="app.ico"
        Width="1400" Height="700"
        MinWidth="800" MinHeight="500"
        Background="{StaticResource PanelBackground}"
        WindowStartupLocation="CenterScreen">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="264" MinWidth="180" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- APP BAR: Application-global strip (always visible, right of sidebar) -->
        <Border Grid.Row="0" Grid.Column="2"
                Background="{StaticResource SidebarBackground}"
                BorderBrush="#3C3C3C" BorderThickness="0,0,0,1"
                MinHeight="36">
            <DockPanel Margin="12,6">
                <!-- Right side: Settings + Help buttons -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal"
                            VerticalAlignment="Center">
                    <Button x:Name="BtnSettings"
                            Click="BtnSettings_Click"
                            ToolTip="Settings"
                            Background="Transparent"
                            BorderThickness="0"
                            Cursor="Hand"
                            Padding="6,4"
                            Margin="4,0,0,0"
                            VerticalAlignment="Center">
                        <Path Data="M19.14,12.94c0.04,-0.3 0.06,-0.61 0.06,-0.94c0,-0.32 -0.02,-0.64 -0.07,-0.94l2.03,-1.58c0.18,-0.14 0.23,-0.41 0.12,-0.61l-1.92,-3.32c-0.12,-0.22 -0.37,-0.29 -0.59,-0.22l-2.39,0.96c-0.5,-0.38 -1.03,-0.7 -1.62,-0.94L14.4,2.81c-0.04,-0.24 -0.24,-0.41 -0.48,-0.41h-3.84c-0.24,0 -0.43,0.17 -0.47,0.41L9.25,5.35C8.66,5.59 8.12,5.92 7.63,6.29L5.24,5.33c-0.22,-0.08 -0.47,0 -0.59,0.22L2.74,8.87C2.62,9.08 2.66,9.34 2.86,9.48l2.03,1.58C4.84,11.36 4.8,11.69 4.8,12s0.02,0.64 0.07,0.94l-2.03,1.58c-0.18,0.14 -0.23,0.41 -0.12,0.61l1.92,3.32c0.12,0.22 0.37,0.29 0.59,0.22l2.39,-0.96c0.5,0.38 1.03,0.7 1.62,0.94l0.36,2.54c0.05,0.24 0.24,0.41 0.48,0.41h3.84c0.24,0 0.44,-0.17 0.47,-0.41l0.36,-2.54c0.59,-0.24 1.13,-0.56 1.62,-0.94l2.39,0.96c0.22,0.08 0.47,0 0.59,-0.22l1.92,-3.32c0.12,-0.22 0.07,-0.47 -0.12,-0.61L19.14,12.94z M12,15.6c-1.98,0 -3.6,-1.62 -3.6,-3.6s1.62,-3.6 3.6,-3.6s3.6,1.62 3.6,3.6S13.98,15.6 12,15.6z"
                              Fill="#888888" Width="16" Height="16"
                              Stretch="Uniform" />
                    </Button>
                    <Button x:Name="BtnHelp"
                            Click="BtnHelp_Click"
                            ToolTip="About CC Director"
                            Background="Transparent"
                            BorderThickness="0"
                            Cursor="Hand"
                            Padding="6,4"
                            Margin="4,0,0,0"
                            VerticalAlignment="Center">
                        <TextBlock Text="?"
                                   Foreground="#888888"
                                   FontSize="14"
                                   FontWeight="Bold" />
                    </Button>
                </StackPanel>
                <!-- Left side: Usage badges (always visible, all accounts) -->
                <StackPanel x:Name="AppBarUsagePanel" Orientation="Horizontal"
                            VerticalAlignment="Center">
                    <!-- Populated dynamically by code-behind -->
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- SESSION BAR: Session-specific header (only visible when session selected) -->
        <Border x:Name="SessionHeaderBanner" Grid.Row="1" Grid.Column="2"
                Background="#007ACC"
                BorderBrush="#005A9E" BorderThickness="0,0,0,2"
                MinHeight="42"
                Visibility="Collapsed">
            <Grid Margin="12,6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Session name -->
                <TextBlock x:Name="HeaderSessionName" Grid.Column="0" Grid.Row="0"
                           Text=""
                           Foreground="White"
                           FontSize="20"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis" />

                <!-- Activity state badge + message count + refresh -->
                <StackPanel Grid.Column="1" Grid.Row="0"
                            Orientation="Horizontal"
                            VerticalAlignment="Center">
                    <!-- Refresh terminal button -->
                    <Button x:Name="BtnRefreshTerminal"
                            Click="BtnRefreshTerminal_Click"
                            ToolTip="Refresh terminal display"
                            Background="Transparent"
                            BorderThickness="0"
                            Cursor="Hand"
                            Padding="6,4"
                            Margin="0,0,8,0"
                            VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M12,4V1L8,5l4,4V6c3.31,0 6,2.69 6,6 0,1.01 -0.25,1.97 -0.7,2.8l1.46,1.46C19.54,15.03 20,13.57 20,12 20,7.58 16.42,4 12,4z M12,18c-3.31,0 -6,-2.69 -6,-6 0,-1.01 0.25,-1.97 0.7,-2.8L5.24,7.74C4.46,8.97 4,10.43 4,12c0,4.42 3.58,8 8,8v3l4,-4 -4,-4v3z"
                                  Fill="White" Width="14" Height="14"
                                  Stretch="Uniform" />
                            <TextBlock Text="Refresh"
                                       Foreground="White"
                                       FontSize="11"
                                       Margin="4,0,0,0"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>

                    <!-- Message count badge -->
                    <Border x:Name="HeaderMessageCountBadge"
                            Background="#1E40AF"
                            CornerRadius="4"
                            Padding="8,4"
                            Margin="0,0,8,0"
                            VerticalAlignment="Center"
                            Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock x:Name="HeaderMessageCountText"
                                       Text="0"
                                       Foreground="White"
                                       FontSize="12"
                                       FontWeight="SemiBold" />
                            <TextBlock Text=" msgs"
                                       Foreground="White"
                                       FontSize="12"
                                       Opacity="0.8" />
                        </StackPanel>
                    </Border>

                    <!-- Activity state badge -->
                    <Border x:Name="HeaderStateBadge"
                            CornerRadius="4"
                            Padding="10,4"
                            VerticalAlignment="Center"
                            Background="#005A9E">
                        <TextBlock x:Name="HeaderStateBadgeText"
                                   Text="Starting"
                                   Foreground="White"
                                   FontSize="12"
                                   FontWeight="SemiBold" />
                    </Border>
                </StackPanel>

                <!-- Session ID and verification row (right-aligned) -->
                <StackPanel x:Name="HeaderSessionIdPanel" Grid.Column="1" Grid.Row="1"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Margin="0,4,0,0"
                            Visibility="Collapsed">
                    <!-- Claude ID with aligned label -->
                    <TextBlock Text="Claude ID:"
                               Foreground="#87CEFA"
                               FontSize="10"
                               VerticalAlignment="Center" />
                    <TextBlock x:Name="HeaderSessionId"
                               Text="Not linked"
                               Foreground="#E0E0E0"
                               FontSize="10"
                               FontFamily="Consolas, Courier New"
                               Margin="4,0,0,0"
                               VerticalAlignment="Center" />
                    <!-- Verification badge -->
                    <Border x:Name="HeaderVerificationBadge"
                            CornerRadius="2"
                            Padding="4,1"
                            Margin="6,0,0,0"
                            VerticalAlignment="Center">
                        <TextBlock x:Name="HeaderVerificationText"
                                   Text="OK"
                                   FontSize="9"
                                   FontWeight="SemiBold"
                                   Foreground="White" />
                    </Border>
                    <!-- Re-link button -->
                    <Button x:Name="BtnRelink"
                            Content="Re-link"
                            Click="BtnRelink_Click"
                            Visibility="Collapsed"
                            Margin="6,0,0,0"
                            Padding="6,2"
                            FontSize="10"
                            Background="#005A9E"
                            Foreground="#E0E0E0"
                            BorderThickness="0"
                            Cursor="Hand" />
                    <!-- Separator -->
                    <TextBlock Text="|"
                               Foreground="#4A5568"
                               FontSize="10"
                               Margin="12,0"
                               VerticalAlignment="Center" />
                    <!-- Director ID with aligned label -->
                    <TextBlock Text="Director ID:"
                               Foreground="#87CEFA"
                               FontSize="10"
                               VerticalAlignment="Center" />
                    <TextBlock x:Name="HeaderDirectorId"
                               Foreground="#E0E0E0"
                               FontSize="10"
                               FontFamily="Consolas, Courier New"
                               Margin="4,0,0,0"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Grid>
        </Border>

            <!-- SIDEBAR: Session navigation (full height, spans all rows) -->
            <Border Grid.Row="0" Grid.RowSpan="3" Grid.Column="0" Background="{StaticResource SidebarBackground}"
                    BorderBrush="#3C3C3C" BorderThickness="0,0,1,0">
                <DockPanel>
                    <!-- Header with hamburger menu and title -->
                    <DockPanel DockPanel.Dock="Top" Margin="8,10,8,4">
                        <Button x:Name="BtnAppMenu" Content="&#x2630;"
                                Click="BtnAppMenu_Click"
                                Focusable="False"
                                Background="Transparent"
                                Foreground="{StaticResource TextForeground}"
                                BorderThickness="0"
                                Cursor="Hand"
                                FontSize="16"
                                Padding="4,0"
                                VerticalAlignment="Center"
                                ToolTip="Application menu">
                            <Button.ContextMenu>
                                <ContextMenu x:Name="AppMenu">
                                    <MenuItem Header="Repositories..." Click="MenuRepositories_Click"
                                              ToolTip="Manage root directories and repositories" />
                                    <MenuItem Header="Accounts..." Click="MenuAccounts_Click"
                                              ToolTip="Manage Claude subscription accounts" />
                                    <Separator />
                                    <MenuItem Header="Open Logs" Click="BtnOpenLogs_Click"
                                              ToolTip="Open log directory in Explorer" />
                                    <MenuItem Header="Open Sessions" Click="BtnOpenSessions_Click"
                                              ToolTip="Open sessions.json in default editor" />
                                    <Separator />
                                    <MenuItem Header="Open History" Click="BtnOpenHistory_Click"
                                              ToolTip="Open session history folder in Explorer" />
                                    <MenuItem Header="History in VS Code" Click="BtnOpenHistoryVsCode_Click"
                                              ToolTip="Open session history folder in VS Code" />
                                </ContextMenu>
                            </Button.ContextMenu>
                        </Button>
                        <TextBlock Text="SESSIONS"
                                   Foreground="{StaticResource TextForeground}"
                                   FontWeight="SemiBold"
                                   FontSize="12"
                                   VerticalAlignment="Center"
                                   Margin="6,0,0,0" />
                    </DockPanel>

                    <!-- New Session button -->
                    <Button x:Name="BtnNewSession" DockPanel.Dock="Top"
                            Content="+ New Session"
                            Click="BtnNewSession_Click"
                            Focusable="False"
                            Height="30" Margin="8,2,8,6"
                            Background="{StaticResource AccentBrush}"
                            Foreground="White"
                            BorderThickness="0"
                            Cursor="Hand" />

                    <!-- Usage summary panel (always visible in sidebar) -->
                    <StackPanel x:Name="SidebarUsagePanel" DockPanel.Dock="Bottom"
                                Margin="8,4,8,2">
                        <!-- Populated dynamically; shows compact usage per account -->
                    </StackPanel>

                    <!-- StatusFooter: build info at bottom -->
                    <TextBlock x:Name="BuildInfoText" DockPanel.Dock="Bottom"
                               Text="Build: ---"
                               Foreground="#555555"
                               FontSize="9"
                               HorizontalAlignment="Center"
                               Margin="0,4,0,8" />

                    <ListBox x:Name="SessionList"
                             SelectionChanged="SessionList_SelectionChanged"
                             IsTabStop="False"
                             KeyboardNavigation.TabNavigation="None"
                             PreviewKeyDown="SessionList_PreviewKeyDown"
                             AllowDrop="True"
                             PreviewMouseMove="SessionList_PreviewMouseMove"
                             PreviewMouseLeftButtonDown="SessionList_PreviewMouseLeftButtonDown"
                             DragOver="SessionList_DragOver"
                             Drop="SessionList_Drop"
                             DragLeave="SessionList_DragLeave"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="{StaticResource TextForeground}"
                             Margin="4,0">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="IsTabStop" Value="False" />
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="Margin" Value="0" />
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ContextMenu>
                                        <ContextMenu Opened="SessionContextMenu_Opened" Closed="SessionContextMenu_Closed">
                                            <MenuItem Header="Rename" Click="MenuRenameSession_Click" />
                                            <Separator />
                                            <MenuItem Header="Open in Explorer" Click="MenuOpenInExplorer_Click" />
                                            <MenuItem Header="Open in VS Code" Click="MenuOpenInVsCode_Click" />
                                            <MenuItem Header="GitHub Issues" Click="MenuGitHubIssues_Click" />
                                            <Separator />
                                            <MenuItem Header="Add to Accounts" Click="MenuAddToAccounts_Click"
                                                      ToolTip="Capture current Claude credentials as a saved account" />
                                            <Separator />
                                            <MenuItem Header="Close Session" Click="MenuCloseSession_Click" />
                                        </ContextMenu>
                                    </Grid.ContextMenu>
                                    <Border BorderBrush="{Binding ActivityBrush}"
                                            BorderThickness="4,0,0,0"
                                            Padding="6,4,4,4">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <!-- Row 0: Display name + Status text -->
                                            <StackPanel Grid.Row="0">
                                                <!-- Session name -->
                                                <TextBlock Text="{Binding DisplayName}"
                                                           FontWeight="Medium"
                                                           FontSize="13"
                                                           TextTrimming="CharacterEllipsis" />
                                                <!-- Status: Working (PID xxx) - ConPTY -->
                                                <TextBlock Text="{Binding StatusText}"
                                                           FontSize="10"
                                                           Foreground="#888888"
                                                           Margin="0,1,0,0" />
                                            </StackPanel>

                                            <!-- Row 1: ClaudeSessionId + Verification badge + [Open] [Relink] buttons -->
                                            <DockPanel Grid.Row="1" Margin="0,4,0,0">
                                                <!-- Buttons (right-aligned) -->
                                                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="6,0,0,0">
                                                    <!-- Open .jsonl button -->
                                                    <Button Content="Open"
                                                            Click="SessionOpenJsonl_Click"
                                                            Focusable="False"
                                                            FontSize="9"
                                                            Padding="6,2"
                                                            Margin="0,0,4,0"
                                                            Background="#374151"
                                                            Foreground="#D1D5DB"
                                                            BorderThickness="0"
                                                            Cursor="Hand"
                                                            ToolTip="Open .jsonl file in Explorer">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Setter Property="IsEnabled" Value="True" />
                                                                <Style.Triggers>
                                                                    <!-- Hide when waiting for terminal verification -->
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                    <!-- Hide when terminal verification failed -->
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationFailed}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                    <!-- Disable when file not found or error -->
                                                                    <DataTrigger Binding="{Binding Session.VerificationStatus}" Value="FileNotFound">
                                                                        <Setter Property="IsEnabled" Value="False" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Session.VerificationStatus}" Value="Error">
                                                                        <Setter Property="IsEnabled" Value="False" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                    <!-- Relink button -->
                                                    <Button Content="Relink"
                                                            Click="SessionRelink_Click"
                                                            Focusable="False"
                                                            FontSize="9"
                                                            Padding="6,2"
                                                            Background="#374151"
                                                            Foreground="#D1D5DB"
                                                            BorderThickness="0"
                                                            Cursor="Hand"
                                                            ToolTip="Re-link to a different Claude session">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Style.Triggers>
                                                                    <!-- Hide when waiting for terminal verification -->
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                </StackPanel>
                                                <!-- Terminal Verification badge -->
                                                <Border CornerRadius="2"
                                                        Padding="4,1"
                                                        Margin="0,0,4,0"
                                                        VerticalAlignment="Center"
                                                        ToolTip="{Binding TerminalVerificationStatusText}">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="Background" Value="#22C55E" />
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                            <Style.Triggers>
                                                                <!-- Gray for waiting -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Setter Property="Background" Value="#6B7280" />
                                                                </DataTrigger>
                                                                <!-- Yellow/Orange for potential match -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationPotential}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Setter Property="Background" Value="#F59E0B" />
                                                                </DataTrigger>
                                                                <!-- Green for confirmed match -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationMatched}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Setter Property="Background" Value="#22C55E" />
                                                                </DataTrigger>
                                                                <!-- Red for failed -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationFailed}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Setter Property="Background" Value="#EF4444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock FontSize="8" FontWeight="Bold" Foreground="White">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="OK" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                        <Setter Property="Text" Value="?" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationPotential}" Value="True">
                                                                        <Setter Property="Text" Value="?" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationFailed}" Value="True">
                                                                        <Setter Property="Text" Value="!" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                                <!-- Claude session ID or status text -->
                                                <TextBlock FontFamily="Consolas, Courier New"
                                                           FontSize="10"
                                                           VerticalAlignment="Center">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Text" Value="{Binding ClaudeSessionIdShort}" />
                                                            <Setter Property="Foreground" Value="#9CA3AF" />
                                                            <Style.Triggers>
                                                                <!-- Show "Waiting..." when waiting -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                    <Setter Property="Text" Value="Waiting..." />
                                                                    <Setter Property="Foreground" Value="#6B7280" />
                                                                </DataTrigger>
                                                                <!-- Show session ID in yellow/orange when potential match -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationPotential}" Value="True">
                                                                    <Setter Property="Foreground" Value="#F59E0B" />
                                                                </DataTrigger>
                                                                <!-- Show "Verification Failed" in red when failed -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationFailed}" Value="True">
                                                                    <Setter Property="Text" Value="Verification Failed" />
                                                                    <Setter Property="Foreground" Value="#EF4444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </DockPanel>

                                            <!-- Row 2: Stats badges + three-dot menu -->
                                            <DockPanel Grid.Row="2" Margin="0,4,0,0">
                                                <!-- Three-dot menu button (right-aligned) -->
                                                <Button DockPanel.Dock="Right"
                                                        Content="..."
                                                        Click="SessionMenuButton_Click"
                                                        Focusable="False"
                                                        VerticalAlignment="Center"
                                                        Padding="6,2"
                                                        Margin="4,0,0,0"
                                                        MinWidth="24"
                                                        Background="Transparent"
                                                        Foreground="#888888"
                                                        BorderThickness="0"
                                                        Cursor="Hand"
                                                        FontWeight="Bold"
                                                        FontSize="12"
                                                        ToolTip="Session options">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Opacity" Value="0.5" />
                                                            <Style.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="Opacity" Value="1" />
                                                                    <Setter Property="Foreground" Value="#CCCCCC" />
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>
                                                <!-- Stats badges -->
                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                    <!-- Message count badge -->
                                                    <Border Background="#3B82F6"
                                                            CornerRadius="8"
                                                            Padding="6,2"
                                                            Margin="0,0,6,0"
                                                            VerticalAlignment="Center">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HasClaudeMetadata}" Value="False">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding ClaudeMessageCount}"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       FontWeight="SemiBold" />
                                                            <TextBlock Text=" msgs"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       Opacity="0.8" />
                                                        </StackPanel>
                                                    </Border>
                                                    <!-- Uncommitted changes badge (orange) -->
                                                    <Border Background="#D97706"
                                                            CornerRadius="8"
                                                            Padding="6,2"
                                                            VerticalAlignment="Center">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HasUncommittedChanges}" Value="False">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding UncommittedCount}"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       FontWeight="SemiBold" />
                                                            <TextBlock Text=" uncommitted"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       Opacity="0.8" />
                                                        </StackPanel>
                                                    </Border>
                                                    <!-- Queued messages badge (red) -->
                                                    <Border Background="#DC2626"
                                                            CornerRadius="8"
                                                            Padding="6,2"
                                                            VerticalAlignment="Center">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HasQueuedMessages}" Value="False">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding QueuedCount}"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       FontWeight="SemiBold" />
                                                            <TextBlock Text=" queued"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       Opacity="0.8" />
                                                        </StackPanel>
                                                    </Border>
                                                </StackPanel>
                                            </DockPanel>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>

            <!-- Splitter (left) -->
            <GridSplitter Grid.Row="0" Grid.RowSpan="3" Grid.Column="1" Width="3"
                          Focusable="False"
                          Background="{StaticResource PanelBackground}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch" />

            <!-- CENTER WORKSPACE: content area -->
            <Grid Grid.Row="2" Grid.Column="2" Background="#1E1E1E">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition x:Name="HookEventsColumn" Width="280" />
                    </Grid.ColumnDefinitions>

                    <!-- TerminalColumn: tabs + notification + command bar -->
                    <Grid Grid.Column="0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <TextBlock x:Name="PlaceholderText" Grid.Row="0"
                                   Text="Select or create a session to begin"
                                   Foreground="#555555"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   FontSize="16" />

                        <!-- ContentTabs: Terminal / Source Control / Repositories -->
                        <TabControl x:Name="SessionTabs" Grid.Row="0"
                                    Visibility="Collapsed"
                                    Background="#1E1E1E"
                                    BorderThickness="0">
                            <TabControl.Resources>
                                <Style TargetType="TabItem">
                                    <Setter Property="Background" Value="#2D2D2D" />
                                    <Setter Property="Foreground" Value="#888888" />
                                    <Setter Property="BorderThickness" Value="0" />
                                    <Setter Property="Padding" Value="12,6" />
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="TabItem">
                                                <Border x:Name="TabBorder"
                                                        Background="{TemplateBinding Background}"
                                                        Padding="{TemplateBinding Padding}">
                                                    <Grid>
                                                        <ContentPresenter ContentSource="Header"
                                                                          HorizontalAlignment="Center"
                                                                          VerticalAlignment="Center" />
                                                        <Border x:Name="BottomAccent"
                                                                Height="2"
                                                                VerticalAlignment="Bottom"
                                                                Margin="0,0,0,-6"
                                                                Background="Transparent" />
                                                    </Grid>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter Property="Background" Value="#1E1E1E" />
                                                        <Setter Property="Foreground" Value="#CCCCCC" />
                                                        <Setter TargetName="BottomAccent" Property="Background" Value="#007ACC" />
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </TabControl.Resources>

                            <TabItem Header="Terminal">
                                <Grid Background="#1E1E1E">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition x:Name="SummaryColumn" Width="0" />
                                    </Grid.ColumnDefinitions>
                                    <Border x:Name="TerminalArea" Grid.Column="0" Background="#1E1E1E" />
                                    <ScrollBar x:Name="TerminalScrollBar" Grid.Column="1"
                                               Orientation="Vertical"
                                               Visibility="Collapsed"
                                               Style="{StaticResource TerminalScrollBarStyle}"
                                               ValueChanged="TerminalScrollBar_ValueChanged" />

                                    <!-- Summary Panel Splitter -->
                                    <GridSplitter x:Name="SummarySplitter" Grid.Column="2"
                                                  Width="5" Background="#2D2D30"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Stretch"
                                                  Visibility="Collapsed" />

                                    <!-- SummaryPane -->
                                    <Border x:Name="SummaryPanel" Grid.Column="3"
                                            Background="#1E1E1E" BorderBrush="#3C3C3C"
                                            BorderThickness="1,0,0,0"
                                            Visibility="Collapsed">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>

                                            <!-- Header -->
                                            <Border Grid.Row="0" Background="#252526" Padding="8,6">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="SESSION SUMMARY"
                                                               Foreground="#888888" FontSize="11"
                                                               FontWeight="SemiBold"
                                                               VerticalAlignment="Center" />
                                                    <Button x:Name="CloseSummaryButton" Grid.Column="1"
                                                            Content="" FontSize="10"
                                                            Background="Transparent" Foreground="#888888"
                                                            BorderThickness="0" Padding="4,2"
                                                            Cursor="Hand"
                                                            Click="CloseSummaryButton_Click"
                                                            ToolTip="Hide summary panel" />
                                                </Grid>
                                            </Border>

                                            <!-- Summary Content -->
                                            <Grid Grid.Row="1">
                                                <!-- Empty state message -->
                                                <TextBlock x:Name="SummaryEmptyText"
                                                           Text="No turns yet. Summaries will appear here as you interact with Claude."
                                                           Foreground="#6B7280" FontSize="11"
                                                           FontStyle="Italic"
                                                           TextWrapping="Wrap"
                                                           Margin="12,16"
                                                           VerticalAlignment="Top" />

                                                <ScrollViewer VerticalScrollBarVisibility="Auto"
                                                              HorizontalScrollBarVisibility="Disabled"
                                                              Background="#1E1E1E">
                                                    <ItemsControl x:Name="SummaryItemsControl" Padding="8,4">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <StackPanel Margin="0,4,0,8">
                                                                    <TextBlock Text="{Binding Header}"
                                                                               Foreground="#569CD6" FontSize="11"
                                                                               FontWeight="SemiBold"
                                                                               Margin="0,0,0,2" />
                                                                    <TextBlock Text="{Binding Summary}"
                                                                               Foreground="#CCCCCC" FontSize="12"
                                                                               TextWrapping="Wrap"
                                                                               LineHeight="18" />
                                                                </StackPanel>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </ScrollViewer>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </TabItem>
                            <TabItem x:Name="SourceControlTab" Header="Source Control"
                                     Visibility="Collapsed">
                                <controls:GitChangesControl x:Name="GitChanges" />
                            </TabItem>
                        </TabControl>

                        <!-- NotificationStrip (inside TerminalColumn) -->
                        <Border x:Name="NotificationBar" Grid.Row="1"
                                Background="{StaticResource SidebarBackground}"
                                BorderBrush="#3C3C3C" BorderThickness="0,1,0,0"
                                Padding="8,4">
                            <DockPanel>
                                <!-- Info icon (left) -->
                                <TextBlock x:Name="NotificationIcon" DockPanel.Dock="Left"
                                           Text="&#x2139;"
                                           Foreground="#3B82F6"
                                           FontSize="14"
                                           VerticalAlignment="Center"
                                           Margin="0,0,8,0"
                                           Visibility="Collapsed" />
                                <!-- Message text (fills remaining space) -->
                                <TextBlock x:Name="NotificationText"
                                           Text=""
                                           Foreground="#CCCCCC"
                                           FontSize="12"
                                           VerticalAlignment="Center"
                                           TextTrimming="CharacterEllipsis" />
                            </DockPanel>
                        </Border>

                        <!-- CommandBar (inside TerminalColumn) -->
                        <Border x:Name="PromptBar" Grid.Row="2" Background="{StaticResource SidebarBackground}"
                                BorderBrush="#3C3C3C" BorderThickness="0,1,0,0" Padding="8"
                                SizeChanged="PromptArea_SizeChanged"
                                Visibility="Collapsed">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="PromptInput"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"
                                         MinLines="3"
                                         MinHeight="65"
                                         MaxHeight="160"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="#1E1E1E"
                                         Foreground="#CCCCCC"
                                         CaretBrush="#CCCCCC"
                                         BorderBrush="#3C3C3C"
                                         BorderThickness="1"
                                         Padding="8,6"
                                         FontFamily="Cascadia Mono, Consolas, Courier New"
                                         FontSize="13"
                                         KeyDown="PromptInput_KeyDown"
                                         GotFocus="PromptInput_GotFocus" />
                                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Bottom">
                                    <Button Content="Send"
                                            Click="BtnSendPrompt_Click"
                                            Width="60" Margin="8,0,0,0"
                                            Height="30"
                                            Background="{StaticResource AccentBrush}"
                                            Foreground="White"
                                            BorderThickness="0"
                                            Cursor="Hand" />
                                    <Button x:Name="BtnQueuePrompt" Content="Queue"
                                            Click="BtnQueuePrompt_Click"
                                            Width="60" Margin="4,0,0,0"
                                            Height="30"
                                            Background="{StaticResource ButtonBackground}"
                                            Foreground="{StaticResource TextForeground}"
                                            BorderThickness="0"
                                            Cursor="Hand"
                                            ToolTip="Add to prompt queue (Ctrl+Shift+Enter)" />
                                    <Button Content="&#x21bb;" Click="BtnRefreshConsole_Click"
                                            Width="30" Margin="4,0,0,0"
                                            Height="30"
                                            Background="{StaticResource ButtonBackground}"
                                            Foreground="{StaticResource TextForeground}"
                                            BorderThickness="0"
                                            Cursor="Hand"
                                            ToolTip="Reposition console overlay"
                                            FontSize="16" />
                                </StackPanel>
                            </Grid>
                        </Border>
                    </Grid>

                    <!-- InspectorToggle -->
                    <Border Grid.Column="1" Background="{StaticResource SidebarBackground}" Width="24">
                        <Button x:Name="HookToggleButton" Content="&#x00BB;"
                                Click="ToggleHookEvents_Click"
                                Focusable="False"
                                Background="Transparent" Foreground="#888888"
                                BorderThickness="0" Cursor="Hand"
                                FontSize="14" VerticalAlignment="Center"
                                ToolTip="Toggle right panel" />
                    </Border>

                    <!-- InspectorPanel: tabbed Queue and Hook Events (full height) -->
                    <Border x:Name="HookEventsPanel" Grid.Column="2" Background="{StaticResource SidebarBackground}"
                            BorderBrush="#3C3C3C" BorderThickness="1,0,0,0">
                        <TabControl x:Name="RightPanelTabs" Background="Transparent" BorderThickness="0" Margin="0,8,0,0">
                            <TabControl.Resources>
                                <Style TargetType="TabItem">
                                    <Setter Property="Foreground" Value="#AAAAAA" />
                                    <Setter Property="Background" Value="Transparent" />
                                    <Setter Property="BorderThickness" Value="0" />
                                    <Setter Property="Padding" Value="10,4" />
                                    <Setter Property="FontSize" Value="11" />
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="TabItem">
                                                <Border x:Name="TabBorder" Background="{TemplateBinding Background}"
                                                        Padding="{TemplateBinding Padding}"
                                                        BorderThickness="0,0,0,2" BorderBrush="Transparent">
                                                    <ContentPresenter ContentSource="Header" />
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="TabBorder" Property="BorderBrush" Value="{StaticResource AccentBrush}" />
                                                        <Setter Property="Foreground" Value="White" />
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="TabBorder" Property="Background" Value="#2A2A2A" />
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </TabControl.Resources>

                            <!-- Queue Tab -->
                            <TabItem x:Name="QueueTab">
                                <TabItem.Header>
                                    <TextBlock x:Name="QueueTabHeader" Text="Queue" />
                                </TabItem.Header>
                                <DockPanel>
                                    <DockPanel DockPanel.Dock="Top" Margin="8,8,8,4">
                                        <TextBlock x:Name="QueueCountText" Text="0 items"
                                                   Foreground="#888888" FontSize="10"
                                                   VerticalAlignment="Center" />
                                        <Button Content="Clear" Click="BtnClearQueue_Click"
                                                HorizontalAlignment="Right"
                                                Padding="8,2"
                                                Background="{StaticResource ButtonBackground}"
                                                Foreground="{StaticResource TextForeground}"
                                                BorderThickness="0" Cursor="Hand" FontSize="10" />
                                    </DockPanel>

                                    <ListBox x:Name="QueueItemsList"
                                             Background="Transparent" BorderThickness="0"
                                             Foreground="{StaticResource TextForeground}"
                                             Margin="4,0"
                                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                             MouseDoubleClick="QueueItemsList_MouseDoubleClick">
                                        <ListBox.ItemContainerStyle>
                                            <Style TargetType="ListBoxItem">
                                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                                <Setter Property="Background" Value="Transparent" />
                                                <Setter Property="BorderThickness" Value="0" />
                                                <Setter Property="Padding" Value="2" />
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="ListBoxItem">
                                                            <Border Background="{TemplateBinding Background}"
                                                                    Padding="{TemplateBinding Padding}"
                                                                    Margin="0,1">
                                                                <ContentPresenter />
                                                            </Border>
                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="Background" Value="#2A2A2A" />
                                                                </Trigger>
                                                                <Trigger Property="IsSelected" Value="True">
                                                                    <Setter Property="Background" Value="#333333" />
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </ListBox.ItemContainerStyle>
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <DockPanel>
                                                    <TextBlock Text="{Binding Index}" FontSize="10"
                                                               Foreground="#666666" Width="16"
                                                               VerticalAlignment="Top" Margin="0,2,4,0" />
                                                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal"
                                                                VerticalAlignment="Top" Margin="4,0,0,0">
                                                        <Button Content="Pop" Tag="{Binding Id}"
                                                                Click="QueueItemPop_Click"
                                                                Padding="4,1" Margin="0,0,2,0"
                                                                Background="{StaticResource ButtonBackground}"
                                                                Foreground="{StaticResource TextForeground}"
                                                                BorderThickness="0"
                                                                Cursor="Hand" FontSize="9"
                                                                ToolTip="Insert into prompt at cursor" />
                                                        <Button Content="&#x25B2;" Tag="{Binding Id}"
                                                                Click="QueueItemMoveUp_Click"
                                                                Width="20" Height="20" Padding="0"
                                                                Background="Transparent"
                                                                Foreground="#888888" BorderThickness="0"
                                                                Cursor="Hand" FontSize="9"
                                                                ToolTip="Move up" />
                                                        <Button Content="&#x25BC;" Tag="{Binding Id}"
                                                                Click="QueueItemMoveDown_Click"
                                                                Width="20" Height="20" Padding="0"
                                                                Background="Transparent"
                                                                Foreground="#888888" BorderThickness="0"
                                                                Cursor="Hand" FontSize="9"
                                                                ToolTip="Move down" />
                                                        <Button Content="&#x2715;" Tag="{Binding Id}"
                                                                Click="QueueItemRemove_Click"
                                                                Width="20" Height="20" Padding="0"
                                                                Background="Transparent"
                                                                Foreground="#CC4444" BorderThickness="0"
                                                                Cursor="Hand" FontSize="9"
                                                                ToolTip="Remove" />
                                                    </StackPanel>
                                                    <TextBlock Text="{Binding Preview}" FontSize="11"
                                                               Foreground="#CCCCCC" TextWrapping="Wrap"
                                                               MaxHeight="80" TextTrimming="CharacterEllipsis"
                                                               VerticalAlignment="Top" Margin="0,1,0,0" />
                                                </DockPanel>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </DockPanel>
                            </TabItem>

                            <!-- Hook Events Tab -->
                            <TabItem Header="Hooks">
                                <DockPanel>
                                    <DockPanel DockPanel.Dock="Top" Margin="8,8,8,4">
                                        <TextBlock Text="HOOK EVENTS"
                                                   Foreground="{StaticResource TextForeground}"
                                                   FontWeight="SemiBold" FontSize="10"
                                                   VerticalAlignment="Center" />
                                        <Button x:Name="BtnClearHookEvents" Content="Clear"
                                                Click="BtnClearHookEvents_Click"
                                                HorizontalAlignment="Right"
                                                Padding="8,2"
                                                Background="{StaticResource ButtonBackground}"
                                                Foreground="{StaticResource TextForeground}"
                                                BorderThickness="0" Cursor="Hand" FontSize="10" />
                                    </DockPanel>

                                    <ListBox x:Name="HookEventList"
                                             Background="Transparent" BorderThickness="0"
                                             Foreground="{StaticResource TextForeground}"
                                             Margin="4,0"
                                             VirtualizingPanel.IsVirtualizing="True"
                                             VirtualizingPanel.VirtualizationMode="Recycling"
                                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Margin="2,1">
                                                    <DockPanel>
                                                        <TextBlock Text="{Binding Timestamp}" FontSize="9"
                                                                   Foreground="#888888" Margin="0,0,6,0" />
                                                        <TextBlock Text="{Binding EventName}" FontSize="9"
                                                                   Foreground="{Binding EventBrush}" FontWeight="SemiBold" />
                                                    </DockPanel>
                                                    <DockPanel>
                                                        <TextBlock Text="{Binding SessionIdShort}" FontSize="9"
                                                                   Foreground="#666666" Margin="0,0,6,0" />
                                                        <TextBlock Text="{Binding Detail}" FontSize="9"
                                                                   Foreground="#AAAAAA" TextTrimming="CharacterEllipsis" />
                                                    </DockPanel>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </DockPanel>
                            </TabItem>
                        </TabControl>
                    </Border>
                </Grid>

    </Grid>
</Window>
